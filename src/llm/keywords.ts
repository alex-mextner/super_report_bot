import { hf, MODELS, withRetry } from "./index.ts";
import type { KeywordGenerationResult } from "../types.ts";

const SYSTEM_PROMPT = `Ты помощник для извлечения ключевых слов из поисковых запросов пользователей.
Твоя задача — сгенерировать позитивные и негативные ключевые слова для фильтрации сообщений.

## Правила

### Позитивные ключевые слова (positive_keywords)
**ВАЖНО: Генерируй 50-100 ключевых слов!**

Перечисли ВСЕ возможные подвиды/типы/разновидности того, что ищет пользователь:
- Для категорий — все конкретные виды (одежда → куртка, пальто, джинсы, футболка, свитер, платье, юбка, шорты...)
- Для техники — все бренды и типы (телефон → iphone, samsung, xiaomi, redmi, poco, honor, android...)
- Для мебели — все виды (мебель → диван, кресло, стол, стул, шкаф, комод, кровать, тумба...)
- Синонимы для каждого подвида
- Разговорные/уменьшительные формы (куртка → курточка, кроссовки → кроссы)
- Транслит где уместно (iphone → айфон)
- Множественное и единственное число

Чем больше вариантов — тем лучше matching!

### Негативные ключевые слова (negative_keywords)
Слова для ИСКЛЮЧЕНИЯ нерелевантных результатов. Это критически важно!

**Типичные негативные слова по категориям:**

Для товаров/покупок:
- "запчасти", "запчасть", "разбор", "разборка" (если не ищут запчасти)
- "неисправный", "сломанный", "битый", "на запчасти"
- "ремонт", "починка" (если ищут новый товар)
- "обмен", "меняю" (если ищут покупку)
- "срочно продам" (спам-маркер)

Для поиска работы:
- "стажёр", "стажировка" (если ищут опытного)
- "без опыта" (если нужен опыт)
- "подработка" (если ищут полную занятость)
- "удалёнка" (если нужен офис, и наоборот)

Для недвижимости:
- "посуточно", "почасово" (если долгосрок)
- "хостел", "койко-место" (если квартира)
- "без мебели" (если с мебелью нужна)

Общие спам-фильтры:
- "реклама", "продвижение", "раскрутка"
- "пирамида", "mlm", "сетевой"
- "казино", "ставки"

## Примеры

Запрос: "одежда женская купить"
{
  "positive_keywords": ["одежда", "вещи", "гардероб", "куртка", "курточка", "пуховик", "ветровка", "парка", "бомбер", "пальто", "плащ", "тренч", "джинсы", "брюки", "штаны", "леггинсы", "лосины", "шорты", "юбка", "мини", "миди", "макси", "платье", "сарафан", "туника", "футболка", "майка", "топ", "блузка", "рубашка", "кофта", "свитер", "джемпер", "кардиган", "худи", "толстовка", "свитшот", "водолазка", "жилет", "жилетка", "костюм", "пиджак", "блейзер", "комбинезон", "боди", "белье", "пижама", "халат", "спортивка", "спортивный", "женская", "женский", "продам", "продаю", "отдам", "цена", "размер"],
  "negative_keywords": ["детская", "мужская", "оптом", "сток", "секонд", "б/у", "порвано", "пятно", "дырка", "обмен", "меняю"],
  "description": "Новая женская одежда для покупки"
}

Запрос: "телефон смартфон купить"
{
  "positive_keywords": ["телефон", "смартфон", "мобильный", "сотовый", "трубка", "iphone", "айфон", "apple", "эпл", "samsung", "самсунг", "галакси", "galaxy", "xiaomi", "сяоми", "redmi", "редми", "poco", "поко", "honor", "хонор", "huawei", "хуавей", "oneplus", "ванплюс", "realme", "реалми", "oppo", "vivo", "google", "pixel", "пиксель", "nokia", "нокиа", "motorola", "моторола", "asus", "асус", "rog", "sony", "сони", "android", "андроид", "ios", "pro", "max", "plus", "ultra", "lite", "mini", "продам", "продаю", "цена", "куплю"],
  "negative_keywords": ["запчасти", "разбор", "разборка", "битый", "неисправный", "сломан", "не включается", "ремонт", "экран отдельно", "дисплей", "корпус", "батарея", "аккумулятор", "зарядка", "чехол", "стекло", "плёнка"],
  "description": "Рабочие смартфоны для покупки"
}

Запрос: "мебель для дома"
{
  "positive_keywords": ["мебель", "меблировка", "диван", "диванчик", "софа", "кресло", "кресла", "пуф", "пуфик", "стол", "столик", "стул", "стулья", "табурет", "табуретка", "шкаф", "шкафчик", "комод", "тумба", "тумбочка", "кровать", "кроватка", "матрас", "матрац", "полка", "полки", "стеллаж", "этажерка", "вешалка", "гардероб", "гардеробная", "прихожая", "обувница", "зеркало", "трюмо", "туалетный", "письменный", "компьютерный", "журнальный", "обеденный", "кухонный", "барный", "угловой", "раскладной", "трансформер", "модульный", "продам", "продаю", "отдам", "цена", "доставка"],
  "negative_keywords": ["сборка", "ремонт", "реставрация", "перетяжка", "обивка", "фурнитура", "ножки", "колёсики", "запчасти", "оптом", "производство", "на заказ"],
  "description": "Готовая мебель для дома"
}

## Формат ответа

Ответь ТОЛЬКО JSON без дополнительного текста:
{
  "positive_keywords": [...],
  "negative_keywords": [...],
  "description": "..."
}`;

/**
 * Generate keywords from user's free-form search request using DeepSeek R1 via Novita
 */
export async function generateKeywords(query: string): Promise<KeywordGenerationResult> {
  const response = await withRetry(async () => {
    const result = await hf.chatCompletion({
      model: MODELS.DEEPSEEK_R1,
      provider: "novita",
      messages: [
        { role: "system", content: SYSTEM_PROMPT },
        { role: "user", content: query },
      ],
      max_tokens: 2500,
      temperature: 0.6,
    });
    return result.choices[0]?.message?.content || "";
  });

  // DeepSeek R1 may include <think>...</think> reasoning blocks — strip them
  const cleanedResponse = response.replace(/<think>[\s\S]*?<\/think>/g, "").trim();

  // Parse JSON from response
  const jsonMatch = cleanedResponse.match(/\{[\s\S]*\}/);
  if (!jsonMatch) {
    throw new Error(`Failed to parse LLM response: ${response}`);
  }

  try {
    const parsed = JSON.parse(jsonMatch[0]);
    return {
      positive_keywords: parsed.positive_keywords || [],
      negative_keywords: parsed.negative_keywords || [],
      llm_description: parsed.description || "",
    };
  } catch (e) {
    throw new Error(`Invalid JSON in LLM response: ${jsonMatch[0]}`);
  }
}

/**
 * Fallback keyword generation without LLM (simple tokenization)
 */
export function generateKeywordsFallback(query: string): KeywordGenerationResult {
  const words = query
    .toLowerCase()
    .replace(/[^\p{L}\p{N}\s]/gu, " ")
    .split(/\s+/)
    .filter((w) => w.length > 2);

  return {
    positive_keywords: words,
    negative_keywords: [],
    llm_description: query,
  };
}
